<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNCP Explorer - Integrado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .loader { border-top-color: #3b82f6; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <header class="bg-indigo-950 text-white border-b-4 border-amber-500 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-amber-500 p-2 rounded-lg shadow-lg">
                    <i class="fas fa-server text-indigo-950 text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">PNCP <span class="text-amber-400">FullStack</span></h1>
                    <p class="text-[10px] text-slate-300 uppercase tracking-widest font-semibold italic">Conectado ao Backend Local</p>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <section class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden mb-12">
            <div class="p-8">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                    <div class="md:col-span-6">
                        <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">Palavra-chave (Objeto)</label>
                        <input type="text" id="termoInput" class="block w-full px-4 py-3.5 border border-slate-200 rounded-2xl bg-slate-50 text-sm focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all" placeholder="O que deseja encontrar?">
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-xs font-bold text-slate-500 mb-2 uppercase">CNPJ do Órgão</label>
                        <input type="text" id="cnpjInput" class="block w-full px-4 py-3.5 border border-slate-200 rounded-2xl bg-slate-50 text-sm focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all" placeholder="00.000.000/0000-00">
                    </div>
                    <div class="md:col-span-2 flex items-end">
                        <button onclick="buscarLicitacoes(1)" id="searchBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-search" id="btnIcon"></i> BUSCAR
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <div id="statusArea" class="hidden mb-6">
            <div id="statusMessage" class="p-4 rounded-xl border-l-4 font-medium text-sm"></div>
        </div>

        <div id="loading" class="hidden py-20 flex flex-col items-center justify-center text-slate-500">
            <div class="loader ease-linear rounded-full border-4 border-slate-200 h-16 w-16 mb-4"></div>
            <p class="font-bold animate-pulse text-sm">PROCESSANDO VIA BACKEND...</p>
        </div>

        <div id="resultsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>

        <div id="pagination" class="hidden mt-12 flex justify-center items-center gap-4">
            <button id="prevPage" class="h-10 w-10 flex items-center justify-center bg-white border rounded-full hover:bg-indigo-50 text-indigo-600 disabled:opacity-30">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div id="pageIndicator" class="px-6 py-2 bg-indigo-900 text-white rounded-full text-xs font-black">PÁGINA 1</div>
            <button id="nextPage" class="h-10 w-10 flex items-center justify-center bg-white border rounded-full hover:bg-indigo-50 text-indigo-600 disabled:opacity-30">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </main>

    <script>
        const BACKEND_URL = 'http://localhost:3000/api/licitacoes';
        let state = { currentPage: 1, pageSize: 12 };

        async function buscarLicitacoes(page = 1) {
            state.currentPage = page;
            const cnpj = document.getElementById('cnpjInput').value.replace(/\D/g, '');
            const termo = document.getElementById('termoInput').value.trim();
            
            const grid = document.getElementById('resultsGrid');
            const loading = document.getElementById('loading');
            const statusArea = document.getElementById('statusArea');
            const searchBtn = document.getElementById('searchBtn');
            const pagination = document.getElementById('pagination');

            grid.innerHTML = '';
            loading.classList.remove('hidden');
            statusArea.classList.add('hidden');
            pagination.classList.add('hidden');
            searchBtn.disabled = true;

            try {
                const hoje = new Date();
                const inicio = new Date();
                inicio.setMonth(hoje.getMonth() - 12);
                const fmt = (d) => d.toISOString().split('T')[0].replace(/-/g, '');

                let url = `${BACKEND_URL}?pagina=${state.currentPage}&tamanhoPagina=${state.pageSize}`;
                url += `&dataInicial=${fmt(inicio)}&dataFinal=${fmt(hoje)}`;
                if (cnpj) url += `&cnpjOrgao=${cnpj}`;
                if (termo) url += `&objeto=${encodeURIComponent(termo)}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.error) throw new Error(data.message);

                const items = data.data || [];
                const totalPaginas = data.totalPaginas || 1;

                if (items.length === 0) {
                    mostrarStatus('Nenhum edital encontrado via backend.', 'info');
                } else {
                    renderCards(items);
                    setupPagination(totalPaginas);
                }
            } catch (error) {
                mostrarStatus(`Erro no Backend: ${error.message}. Verifique se o server.js está rodando.`, 'error');
            } finally {
                loading.classList.add('hidden');
                searchBtn.disabled = false;
            }
        }

        function renderCards(itens) {
            const grid = document.getElementById('resultsGrid');
            itens.forEach(item => {
                const orgao = item.orgaoEntidade?.razaoSocial || item.nomeOrgao || 'Órgão';
                const objeto = item.objeto || 'Sem descrição';
                const cnpj = item.orgaoEntidade?.cnpj || item.cnpjOrgao || '';
                const ano = item.anoCompra || item.anoLicitacao || '';
                const seq = item.sequencialCompra || item.numeroSequencial || '';
                
                const card = document.createElement('div');
                card.className = "bg-white rounded-3xl shadow-md border border-slate-200 flex flex-col hover:shadow-xl transition-all";
                card.innerHTML = `
                    <div class="p-4 bg-slate-50 border-b flex justify-between items-center text-[10px] font-black uppercase">
                        <span class="text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">Processo</span>
                        <span class="text-slate-400 font-mono italic">${seq}/${ano}</span>
                    </div>
                    <div class="p-6 flex-grow">
                        <h3 class="text-slate-800 font-bold text-sm leading-relaxed line-clamp-2 mb-4">${objeto}</h3>
                        <p class="text-[11px] text-slate-500 truncate"><i class="fas fa-university mr-2 text-slate-300"></i>${orgao}</p>
                    </div>
                    <div class="p-6 bg-slate-50 border-t rounded-b-3xl">
                        <a href="https://pncp.gov.br/app/editais/${cnpj}/${ano}/${seq}" target="_blank" class="w-full flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-black py-3 rounded-xl transition-all">
                            VER NO PORTAL
                        </a>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function setupPagination(total) {
            document.getElementById('pagination').classList.remove('hidden');
            document.getElementById('pageIndicator').textContent = `PÁGINA ${state.currentPage} DE ${total}`;
            document.getElementById('prevPage').disabled = state.currentPage <= 1;
            document.getElementById('nextPage').disabled = state.currentPage >= total;
            document.getElementById('prevPage').onclick = () => buscarLicitacoes(state.currentPage - 1);
            document.getElementById('nextPage').onclick = () => buscarLicitacoes(state.currentPage + 1);
        }

        function mostrarStatus(msg, type) {
            const area = document.getElementById('statusArea');
            const box = document.getElementById('statusMessage');
            area.classList.remove('hidden');
            box.textContent = msg;
            box.className = `p-4 rounded-xl border-l-8 font-bold text-sm ${type === 'error' ? 'bg-red-50 text-red-700 border-red-500' : 'bg-blue-50 text-blue-700 border-blue-500'}`;
        }

        document.getElementById('cnpjInput').addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g, '').slice(0, 14);
            if (v.length > 12) v = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
            else if (v.length > 8) v = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{1,4})$/, '$1.$2.$3/$4');
            e.target.value = v;
        });
    </script>
</body>
</html>